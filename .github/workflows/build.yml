name: HCOWA Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 PySide6 Pillow pyinstaller

      - name: Generate transparent ICO from logo
        shell: python
        run: |
          from PIL import Image
          import os

          src = 'assets/logo.png' if os.path.exists('assets/logo.png') else 'assets/logo.jpg'
          img = Image.open(src).convert('RGBA')

          # 去除白色背景，变透明
          data = img.getdata()
          new_data = []
          for r, g, b, a in data:
              if r > 230 and g > 230 and b > 230:
                  new_data.append((255, 255, 255, 0))
              else:
                  new_data.append((r, g, b, a))
          img.putdata(new_data)

          # 裁剪透明边缘
          bbox = img.getbbox()
          if bbox:
              img = img.crop(bbox)

          # 输出多尺寸 ICO
          img.save('assets/icon.ico', format='ICO',
                   sizes=[(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)])
          print("ICO generated OK")

      - name: Build single EXE
        run: |
          pyinstaller --noconsole --onefile `
            --add-data "assets;assets" `
            --icon "assets/icon.ico" `
            --name HCOWA_Brief_Helper `
            main.py

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/HCOWA_Brief_Helper.exe
          tag_name: ${{ github.ref_name }}
          body: |
            ## HCOWA 每日热点新闻生成器 ${{ github.ref_name }}

            ### 本版更新
            - ✅ 修复 Actions 编译失败（移除 deep_translator，改用内置翻译接口）
            - ✅ 彻底修复日历弹窗乱码（强制 QLocale.C）
            - ✅ 新闻标题和摘要全程中文化
            - ✅ 禁止选择未来日期
            - ✅ 透明背景 LOGO & 图标
            - ✅ 右下角 Zaki 签名
            - ✅ Win11 风格 UI 全新升级

            ### 使用方法
            双击 `HCOWA_Brief_Helper.exe` 即可运行，**无需安装任何软件**。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
